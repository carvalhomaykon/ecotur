{% load static %}

{% include "global/partials/_header.html" %}

<section>
    <h1>Roteiro de Visitas</h1>
    <div id="map"></div>

    <!-- Informações do ponto turístico -->
    <div id="info-ponto" style="display: none;">
        <div class="visitas">
            <div class="ico-loc">
                <img src="{% static "rotas/img/icone-loc.png" %}" alt="Ícone de Localização">
            </div>
            <div class="infor">
                <div class="detalhes">
                    <h2 id="ponto-nome"></h2>
                    <p id="ponto-descricao"></p>
                    <div id="ponto-atividades"></div>
                </div>
            </div>
        </div>
        
        <div class="buttons">
            <button class="concluir" onclick="concluirPonto()">Concluído</button>
            <button class="cancelar" onclick="cancelarPonto()">Cancelar</button>
        </div>
    </div>

    <!-- Botões Iniciar e Cancelar -->
    <div class="buttons" id="botao-iniciar">
        <button class="Iniciar" onclick="iniciarRoteiro()">
            Iniciar
        </button>
        <button class="Cancelar" onclick="limparPontosTuristicos()">
            Cancelar
        </button>
    </div>

</section>
{% include "global/partials/_footer.html" %}

<script>
    let pontosRota = JSON.parse(localStorage.getItem('pontosRota')) || [];
    let mapa;
    let userCoords;
    let pontoAtualIndex = 0;

    document.addEventListener("DOMContentLoaded", function () {
        if (pontosRota.length === 0) {
            alert("Nenhum ponto para exibir na rota.");
            return;
        }

        // Inicializa o mapa com posição padrão
        mapa = L.map('map').setView([-1.457953, -48.478489], 13);

        // Adiciona a camada do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(mapa);

        // Adiciona localização inicial do usuário
        navigator.geolocation.getCurrentPosition(function (position) {
            userCoords = [position.coords.latitude, position.coords.longitude];
            const userMarker = L.marker(userCoords).addTo(mapa);
            userMarker.bindPopup("Você está aqui!");

            // Ordena os pontos turísticos pela distância inicial
            ordenarPontosPorDistancia();

            // Adiciona os pontos turísticos no mapa
            pontosRota.forEach(ponto => {
                const marker = L.marker([ponto.coords[0], ponto.coords[1]]).addTo(mapa);
                marker.bindPopup(`
                    <h3>${ponto.nome}</h3>
                    <p>${ponto.descricao || "Descrição indisponível."}</p>
                `);
            });
        });
    });

    function ordenarPontosPorDistancia() {
        pontosRota.sort((a, b) => {
            const distA = calcularDistancia(userCoords, a.coords);
            const distB = calcularDistancia(userCoords, b.coords);
            return distA - distB;
        });
    }

    function calcularDistancia([lat1, lon1], [lat2, lon2]) {
        const R = 6371; // Raio da Terra em km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distância em km
    }

    function iniciarRoteiro() {
        document.getElementById('botao-iniciar').style.display = 'none';
        showPontoAtual();
    }

    function showPontoAtual() {
        if (pontoAtualIndex >= pontosRota.length) {
            alert("Você completou o roteiro!");
            document.getElementById("info-ponto").style.display = 'none';
            limparPontosTuristicos();
            return;
        }

        const pontoAtual = pontosRota[pontoAtualIndex];
        document.getElementById("ponto-nome").textContent = pontoAtual.nome;
        document.getElementById("ponto-descricao").textContent = pontoAtual.descricao || "Descrição indisponível";
        document.getElementById("ponto-atividades").innerHTML = "<strong>Atividades:</strong> " + (pontoAtual.atividades || "Não informado");
        document.getElementById("info-ponto").style.display = 'block';

        // Atualiza a rota do último ponto visitado até o ponto atual
        const origem = pontoAtualIndex === 0 ? userCoords : pontosRota[pontoAtualIndex - 1].coords;
        const destino = pontoAtual.coords;

        L.Routing.control({
            waypoints: [L.latLng(origem[0], origem[1]), L.latLng(destino[0], destino[1])],
            routeWhileDragging: true
        }).addTo(mapa);
    }

    function concluirPonto() {
        // Atualiza a localização do usuário para o ponto concluído
        userCoords = pontosRota[pontoAtualIndex].coords;
        pontoAtualIndex++;

        if (pontoAtualIndex < pontosRota.length) {
            showPontoAtual();
        } else {
            alert("Você completou o roteiro!");
            document.getElementById("info-ponto").style.display = 'none';
            limparPontosTuristicos();

            // Redireciona para uma aba/página após concluir o roteiro
            window.location.href = "{% url 'historico_rota' %}";
        }
    }

    function limparPontosTuristicos() {
        localStorage.removeItem('pontosRota');
        pontosRota = [];
        alert('Todos os pontos turísticos foram removidos.');
        location.reload();
    }
</script>