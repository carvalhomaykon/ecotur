{% load static %}

{% include "global/partials/_header.html" %}

<section>
    <h1>Roteiro de Visitas</h1>
    <div id="map" style="height: 500px; width: 100%;"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Recupera os pontos turísticos do localStorage
            const pontosRota = JSON.parse(localStorage.getItem('pontosRota')) || [];
            
            // Verifica se há pontos para exibir
            if (pontosRota.length === 0) {
                alert("Nenhum ponto para exibir na rota.");
                return;
            }

            // Inicializa o mapa com posição padrão
            const map = L.map('map').setView([-1.457953, -48.478489], 13);

            // Adiciona a camada do OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Adiciona localização inicial do usuário
            navigator.geolocation.getCurrentPosition(function (position) {
                const userCoords = [position.coords.latitude, position.coords.longitude];
                const userMarker = L.marker(userCoords).addTo(map);
                userMarker.bindPopup("Você está aqui!");

                // Adiciona marcadores dos pontos turísticos ao mapa
                pontosRota.forEach(ponto => {
                    const marker = L.marker([ponto.coords[0], ponto.coords[1]]).addTo(map);
                    marker.bindPopup(`<h3>${ponto.nome}</h3><p>${ponto.descricao || "Descrição indisponível."}</p>`);
                });

                // Gera a rota a partir da localização do usuário
                const rotaCoords = [L.latLng(userCoords), ...pontosRota.map(ponto => L.latLng(ponto.coords[0], ponto.coords[1]))];
                L.Routing.control({
                    waypoints: rotaCoords,
                    routeWhileDragging: true
                }).addTo(map);
            });
        });
    </script>

    <!-- Lista de visitas -->
    <div id="lista-visitas">
        {% for ponto in pontosRota %}
        <div class="visitas">
            <div class="ico-loc">
                <img src="{% static "rotas/img/icone-loc.png" %}" alt="Ícone de Localização">
            </div>
            <div class="infor">
                <div class="detalhes">
                    <a href="#">
                        <h3>{{ ponto.nome }}</h3>
                    </a>
                    <p>{{ ponto.descricao|default:"Distância não calculada" }}</p>
                </div>
                <div class="buttons-detalhes">
                    <button class="concluir">Visitado</button>
                    <button class="cancelar">Cancelar</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="buttons">
        <button class="concluir">   
            Concluir
        </button>
        <button class="cancelar">
            Cancelar
        </button>
    </div>
</section>

{% include "global/partials/_footer.html" %}
