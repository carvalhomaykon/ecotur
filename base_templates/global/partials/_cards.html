{% load static %}

<div class="card-geral">
    <div class="card">
        <div class="img-ponto-turistico">
            <img src="{% static ponto.imagem %}" alt="Imagem {{ ponto.nome }}">
        </div>
        <div class="dados">
            <h3>{{ ponto.nome }}</h3>
            <ul>
                {% for chave, valor in ponto.items %}
                    {% if chave != "coords" and chave != "whatsapp" and chave != "id" and chave != "imagem" %}
                        <li><strong>{{ chave|capfirst }}:</strong> {{ valor }}</li>
                    {% endif %}
                {% endfor %}
                <p><a href="{% url nome_detalhe id=ponto.id %}">Saiba mais</a></p>
            </ul>
            {% if exibir_botao %}
                {% if request.user.is_authenticated %}
                    <div class="button">
                        {% if card_rota %}
                            <button 
                                class="adicionar-rota" 
                                onclick="adicionarRota('{{ ponto.nome }}', {{ ponto.coords|safe }}, '{{ user.username }}')">
                                {{ nome_botao }}
                            </button>
                        {% else %}
                            <a href="{{ ponto.whatsapp }}">
                                <button
                                    class="adicionar-rota">
                                    {{ nome_botao }}
                                </button>
                            </a>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="button">
                        <button class="adicionar-rota">
                            <a href="{% url 'login' %}">{{ frase_login }}</a>
                        </button>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

{% if botao_click %}
    <script>
        let pontosRota = JSON.parse(localStorage.getItem('pontosRota')) || [];
        console.log("Pontos carregados do localStorage:", pontosRota);

        function adicionarRota(pontoNome, pontoCoords, username) {
            if (!username) {
                alert('Você precisa estar logado para adicionar pontos à rota!');
                return;
            }

            try {
                // Garante que pontoCoords seja JSON válido
                pontoCoords = typeof pontoCoords === 'string' ? JSON.parse(pontoCoords) : pontoCoords;
            } catch (error) {
                console.error("Erro ao parsear coordenadas:", pontoCoords);
                return;
            }

            var botao = event.target;
            var textoBotao = botao.innerHTML.trim();

            // Verifica se o ponto já está na lista
            const index = pontosRota.findIndex(p => p.nome === pontoNome && p.username === username);

            if (textoBotao === 'Adicionar à Rota' && index === -1) {
                pontosRota.push({ nome: pontoNome, coords: pontoCoords, username: username });
                botao.innerHTML = 'Rota Adicionada';
                botao.style.backgroundColor = 'red';
                botao.style.color = 'white';

                alert(pontoNome + ' adicionado à Rota!');
                console.log('Ponto adicionado:', { nome: pontoNome, coords: pontoCoords });
            } else if (textoBotao === 'Rota Adicionada' && index !== -1) {
                const removido = pontosRota.splice(index, 1)[0];
                botao.innerHTML = 'Adicionar à Rota';
                botao.style.backgroundColor = '';
                botao.style.color = '';

                alert(pontoNome + ' removido da Rota!');
                console.log('Ponto removido:', removido);
            }

            // Atualiza o localStorage
            localStorage.setItem('pontosRota', JSON.stringify(pontosRota));
            console.log('Estado atual da lista:', pontosRota);

        }
        function limparPontosTuristicos() {
            // Limpa os pontos do localStorage
            localStorage.removeItem('pontosRota');

            // Atualiza a lista em memória
            pontosRota = [];

            // Exibe uma mensagem de confirmação
            alert('Todos os pontos turísticos foram removidos.');

            // Atualiza a interface (se necessário)
            location.reload(); // Recarrega a página para resetar o mapa e a interface
        }

    </script>
{% endif %}